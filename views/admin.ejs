<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/smileyslimeyboy.png">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="admin-header">
        <a href="/" class="logout-btn">View Blog</a>
        <a href="/admin/logout" class="logout-btn">logout</a>
    </div>

    <div class="admin-container">
        <!-- New Post Form -->
        <div class="admin-section">
            <h2>new post</h2>

            <!-- Type toggle -->
            <div style="margin-bottom: 20px;">
                <button type="button" class="type-toggle-btn" data-type="note">notes</button>
                <button type="button" class="type-toggle-btn active" data-type="post">essays</button>
                <button type="button" class="type-toggle-btn" data-type="about">about</button>
            </div>

            <div style="display: flex; gap: 30px;">
                <div style="flex: 1;">
                    <form method="POST" action="/admin/post" id="postForm">
                        <input type="hidden" name="type" id="postType" value="post">
                        <input type="hidden" name="editId" id="editId" value="">

                        <div class="form-group" id="titleGroup">
                            <label for="title">title</label>
                            <input type="text" id="title" name="title" required autofocus>
                        </div>

                        <div class="form-group">
                            <textarea id="content" name="content" required placeholder=""></textarea>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn">publish</button>
                        <button type="button" class="submit-btn" id="cancelEditBtn" style="display: none; background: #999; margin-left: 10px;">cancel</button>
                    </form>
                </div>

                <!-- Sidebar editor - only visible for essays -->
                <div id="sidebarEditor" style="width: 250px; display: block;">
                    <h3 style="margin-top: 0; font-size: 0.95em; font-weight: normal; margin-bottom: 15px;">sidebar topics</h3>
                    <form method="POST" action="/admin/sidebar" id="sidebarForm">
                        <div class="form-group">
                            <textarea id="sidebarContent" name="topics" style="min-height: 150px;" placeholder="one topic per line"></textarea>
                        </div>
                        <button type="submit" class="submit-btn">save topics</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Existing Posts -->
        <div class="admin-section">
            <h2>posts</h2>

            <% if (posts.length === 0) { %>
                <p style="color: #888;">no posts yet</p>
            <% } else { %>
                <div class="posts-list">
                    <% posts.forEach(post => { %>
                        <div class="admin-post">
                            <div class="admin-post-info">
                                <div class="admin-post-title">
                                    <span style="color: #999; font-size: 0.85em;">[<%= post.type || 'post' %>]</span>
                                    <%= post.title.toLowerCase() %>
                                </div>
                                <div class="admin-post-date">
                                    <%= new Date(post.date).toLocaleDateString('en-US', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    }).toLowerCase() %>
                                </div>
                                <div class="admin-post-preview"><%= post.content.substring(0, 100) %>...</div>
                            </div>
                            <div class="admin-post-actions">
                                <button class="edit-btn" onclick="editPost('<%= post.id %>')">edit</button>
                                <form method="POST" action="/admin/delete/<%= post.id %>" class="delete-form"
                                      onsubmit="return confirm('delete this post?');">
                                    <button type="submit" class="delete-btn">delete</button>
                                </form>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } %>
        </div>

        <div style="margin-top: 30px;">
            <a href="/" style="color: #333; text-decoration: none; font-size: 0.9em; text-transform: lowercase;">‚Üê view blog</a>
        </div>
    </div>

    <script>
        // Toggle between essay, note, and about
        const toggleBtns = document.querySelectorAll('.type-toggle-btn');
        const postTypeInput = document.getElementById('postType');
        const titleGroup = document.getElementById('titleGroup');
        const titleInput = document.getElementById('title');
        const contentTextarea = document.getElementById('content');
        const submitBtn = document.getElementById('submitBtn');
        const postForm = document.getElementById('postForm');
        const sidebarEditor = document.getElementById('sidebarEditor');
        const sidebarContent = document.getElementById('sidebarContent');
        const editIdInput = document.getElementById('editId');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        // Load sidebar topics on page load
        fetch('/admin/sidebar-content')
            .then(r => r.json())
            .then(data => {
                if (data.topics) {
                    sidebarContent.value = data.topics.join('\n');
                }
            });

        toggleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all buttons
                toggleBtns.forEach(b => b.classList.remove('active'));
                // Add active to clicked button
                btn.classList.add('active');
                // Update hidden input
                const type = btn.dataset.type;
                postTypeInput.value = type;

                // Handle different content types
                if (type === 'about') {
                    titleGroup.style.display = 'none';
                    titleInput.required = false;
                    submitBtn.textContent = 'save';
                    postForm.action = '/admin/about';
                    sidebarEditor.style.display = 'none';

                    // Load current about content
                    fetch('/admin/about-content')
                        .then(r => r.json())
                        .then(data => {
                            contentTextarea.value = data.content || '';
                        });
                } else if (type === 'post') {
                    // Essays - show sidebar editor
                    titleGroup.style.display = 'block';
                    titleInput.required = true;
                    submitBtn.textContent = 'publish';
                    postForm.action = '/admin/post';
                    contentTextarea.value = '';
                    sidebarEditor.style.display = 'block';
                } else {
                    // Notes - hide sidebar editor
                    titleGroup.style.display = 'block';
                    titleInput.required = true;
                    submitBtn.textContent = 'publish';
                    postForm.action = '/admin/post';
                    contentTextarea.value = '';
                    sidebarEditor.style.display = 'none';
                }
            });
        });

        // Edit post function
        function editPost(postId) {
            fetch(`/admin/edit/${postId}`)
                .then(r => r.json())
                .then(post => {
                    titleInput.value = post.title;
                    contentTextarea.value = post.content;
                    postTypeInput.value = post.type;
                    editIdInput.value = post.id;

                    postForm.action = `/admin/update/${post.id}`;
                    submitBtn.textContent = 'update';
                    cancelEditBtn.style.display = 'inline-block';

                    // Scroll to form
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
        }

        // Cancel edit
        cancelEditBtn.addEventListener('click', () => {
            titleInput.value = '';
            contentTextarea.value = '';
            editIdInput.value = '';
            postForm.action = '/admin/post';
            submitBtn.textContent = 'publish';
            cancelEditBtn.style.display = 'none';
        });
    </script>
</body>
</html>
